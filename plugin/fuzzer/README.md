# Example Usage

## ZLib distributed with binutils (part 1)

This is an example that fuzzy test zlib via the official API, zlib.h.

### Dependencies

Install:
 - bear
 - dextool
 - gcc/g++
 - clang
 - llvm
 - afl
 - google-perftools

### Prepare Fuzz Wrapper

Need a compilation database to make it _easier_ to use.

```sh
./configure
bear make
```

Generate the fuzzy wrapper (first iteration).
Find a file in the compile_commands.json that include zlib.h. Any file will do.
For this example compress.c suffices.

```sh
dextool fuzzer --compile-db compile_commands.json --out dextool --in $(readlink -f compress.c) --file-restrict '.*/zlib\.h'
```

Modify to add `filter="exclude"` to all symbols.
Example:

```xml
    <symbol name="zError" filter="exclude">
```

Rerun dextool with the new configuration file.

```sh
dextool fuzzer --compile-db compile_commands.json --out dextool --config dextool/dextool_config.xml --in $(readlink -f compress.c) --file-restrict '.*/zlib\.h'
```

Let us now choose a couple of functions to fuzz.
These two take no parameters so are easy.
zlibVersion
zlibCompileFlags

This one takes two checksums and an offset.
adler32_combine

Remove those from the list of excluded, rerun dextool.

### Build Fuzzer Binary

Awesome, you now have a fuzzer wrapper that will test the three API functions.
Time to build it.

Rebuild zlib with the AFL instrument tool (adjust the path to where you have AFL installed):
```sh
CFLAGS="-fPIC -fsanitize=undefined" CC=~/src/c/american_fuzzy_lop/afl-gcc ./configure
make clean && make
cp libz.a libz_normal.a
```

Link the library with the fuzz environment:
```sh
~/src/c/american_fuzzy_lop/afl-g++ -O3 -I ~/src/dlang/clang_fun/plugin/fuzzer/support -Idextool $(ls dextool/*.cpp) -o zlib_fuzz -L. -L ~/src/dlang/clang_fun/build/plugin/fuzzer/ -lz_normal -ldextoolfuzz
```

### Fuzzing

Everything ready.

```sh
AFL_SKIP_CPUFREQ=1 ~/src/c/american_fuzzy_lop/afl-fuzz -i dextool/test_case -o fuzz_out ./zlib_fuzz
```

Continue to part 2 to fix the "error" that AFL is complaining about.

### Coverage

For fun, lets see what the coverage is. This requires a slight rebuild but it is worth it.

Rebuild zlib with the AFL instrument tool (adjust the path to where you have AFL installed):
```sh
CFLAGS="-g -fPIC --coverage" CC=~/src/c/american_fuzzy_lop/afl-gcc ./configure
make clean && make
cp libz.a libz_cov.a
```

Link the library with the fuzz environment:
```sh
~/src/c/american_fuzzy_lop/afl-g++ --coverage -g -O3 -I ~/src/dlang/clang_fun/plugin/fuzzer/support -Idextool $(ls dextool/*.cpp) -o zlib_fuzz_cov -L. -L ~/src/dlang/clang_fun/build/plugin/fuzzer/ -lz_cov -ldextoolfuzz_g
```

I recommend to use the tool afl-cov: git@github.com:mrash/afl-cov.git

Using that tool the coverage can be easily and continuously updated.

To run it:
```sh
afl-cov --lcov-web-all --overwrite -d fuzz_out --coverage-cmd "./zlib_fuzz_cov < AFL_FILE"  --code-dir .
```

It'll create a fine html report at:
```sh
firefox fuzz_corpus/cov/web/index.html
```

### Catch more

Try adding the flag: -fsanitize=undefined

It catches undefined behaviour.

## ZLib distributed with binutils (part 2)

Now, part 1 wasn't particularly exciting. Lets make it fun by ac

Remove the following from the dextool configuration and rerun to get the autogenerated parameters:
deflateInit

## Getting clang-fast to work

Ahh you want better speed. Good times.
This is how you get clang-fast to work.

In the examples above afl-g++ or afl-gcc have been used.
Rerun those command lines but replace with afl-clang-fast(++)

To get afl-cov to work you need to do the following gymnastics.

Create a script somewhere, lets call it llvm-gcov:
```sh
#!/bin/bash

llvm-cov gcov $@
```
Add it to your PATH.

Configure lcov to use the script.
Copy the system wide configuration of lcov to the user folder:
```sh
cp /etc/lcov ~/.lcovrc
```

Change the option:
geninfo_gcov_tool = gcov
to
geninfo_gcov_tool = llvm-gcov

## Profiling

Preparation:

```sh
CFLAGS="-g -fPIC -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free" ./configure
make clean && make
cp libz.a libz_prof.a

g++ -g -O3 -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -I ~/src/dlang/clang_fun/plugin/fuzzer/support -Idextool $(ls dextool/*.cpp) -o zlib_fuzz_prof -L. -L ~/src/dlang/clang_fun/build/plugin/fuzzer/ -lz_prof -ldextoolfuzz_g -ltcmalloc_and_profiler -lprofiler
```

Run the program to get some perf data:
```sh
CPUPROFILE=./prof.out ./zlib_fuzz_prof $(find fuzz_out/queue)
```

Look at the data:
```sh
```
